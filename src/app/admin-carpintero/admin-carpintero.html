<app-nav></app-nav>

<main class="admin-container">
  <div class="admin-header">
    <h1>Panel Carpintero / Admin</h1>
    <div class="controls">
      <button class="btn btn-ghost" (click)="loadPending()">Refrescar</button>
      <!-- Mat tabs below provide the tab UI; these header buttons are kept for quick actions only -->
    </div>
  </div>

  <div class="panel">
    <!-- Angular Material tabs: Proyectos pendientes / To-Do -->
    <mat-tab-group class="admin-tabs" (selectedIndexChange)="onTabChange($event)">
      <mat-tab label="Proyectos pendientes">
        <div class="tab-content">
          <h2>Presupuestos pendientes</h2>
          <div class="lista-wrapper">
            <table class="lista">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Cliente</th>
                  <th>Proyecto</th>
                  <th>Total</th>
                  <th>Ver</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (p of pendingPresupuestos; track p.presupuesto_id ?? p.id ?? p) {
                  <tr>
                    <td>{{ p.presupuesto_id }}</td>
                    <td>{{ p.cliente_nombre }}</td>
                    <td>{{ p.proyecto_nombre }}</td>
                    <td>{{ p.total }}</td>
                    <td><button class="btn btn-ghost" (click)="openDetails(p)">Ver</button></td>
                    <td>{{ p.fecha_creacion }}</td>
                    <td class="actions-cell">
                      <button class="btn btn-accept" (click)="accept(p.presupuesto_id)">Aceptar</button>
                      <button class="btn btn-reject" (click)="openReject(p.presupuesto_id)">Rechazar</button>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="To-Do">
        <div class="tab-content">
          <h2>To-Do - Proyectos aceptados</h2>
          @if (acceptedProjects.length === 0) {
            <div>No hay proyectos aceptados.</div>
          }
          <div class="columns-wrapper">
            <div class="column">
              <h3>To-Do</h3>
              @if (todoProjectsList.length === 0) {
                <div class="small-muted">No hay proyectos en To-Do.</div>
              }
              @for (proj of todoProjectsList; track proj.proyecto_id ?? proj.id ?? proj) {
                <div class="project-card">
                  <div class="project-row">
                    <div>
                      <h3>{{ proj.proyecto_nombre }}</h3>
                      <div class="project-meta small-muted">Cliente: {{ proj.cliente_nombre }}</div>
                      <div class="project-meta small-muted">Presupuesto: {{ proj.total || '-' }}</div>
                    </div>
                    <div class="project-meta">Estado: <strong>{{ proj.carpintero_estado }}</strong></div>
                  </div>
                  <div style="margin-top:6px; text-align:right;"><button class="btn btn-ghost" (click)="openDetails(proj)">Ver detalles</button></div>
                  <div class="project-desc">{{ proj.descripcion }}</div>
                  <div class="progress-controls">
                    <label class="small-muted">Estado:</label>
                    <select [ngModel]="proj.pendingEstado ?? proj.carpintero_estado" (ngModelChange)="setPendingStatus(proj, $event)">
                      <option value="to-do">To-Do</option>
                      <option value="in progress">In Progress</option>
                      <option value="done">Done</option>
                    </select>
                    <button class="btn btn-primary" (click)="requestSaveProject(proj)">Guardar</button>
                  </div>
                </div>
              }
            </div>

            <div class="column">
              <h3>In Progress</h3>
              @if (inProgressProjectsList.length === 0) {
                <div class="small-muted">No hay proyectos en progreso.</div>
              }
              @for (proj of inProgressProjectsList; track proj.proyecto_id ?? proj.id ?? proj) {
                <div class="project-card">
                  <div class="project-row">
                    <div>
                      <h3>{{ proj.proyecto_nombre }}</h3>
                      <div class="project-meta small-muted">Cliente: {{ proj.cliente_nombre }}</div>
                      <div class="project-meta small-muted">Presupuesto: {{ proj.total || '-' }}</div>
                    </div>
                    <div class="project-meta">Estado: <strong>{{ proj.carpintero_estado }}</strong></div>
                  </div>
                  <div style="margin-top:6px; text-align:right;"><button class="btn btn-ghost" (click)="openDetails(proj)">Ver detalles</button></div>
                  <div class="project-desc">{{ proj.descripcion }}</div>
                  <div class="progress-controls">
                    <label class="small-muted">Estado:</label>
                    <select [ngModel]="proj.pendingEstado ?? proj.carpintero_estado" (ngModelChange)="setPendingStatus(proj, $event)">
                      <option value="to-do">To-Do</option>
                      <option value="in progress">In Progress</option>
                      <option value="done">Done</option>
                    </select>
                    <button class="btn btn-primary" (click)="requestSaveProject(proj)">Guardar</button>
                  </div>
                </div>
              }
            </div>

            <div class="column">
              <h3>Done</h3>
              @if (doneProjectsList.length === 0) {
                <div class="small-muted">No hay proyectos finalizados.</div>
              }
              @for (proj of doneProjectsList; track proj.proyecto_id ?? proj.id ?? proj) {
                <div class="project-card">
                  <div class="project-row">
                    <div>
                      <h3>{{ proj.proyecto_nombre }}</h3>
                      <div class="project-meta small-muted">Cliente: {{ proj.cliente_nombre }}</div>
                      <div class="project-meta small-muted">Presupuesto: {{ proj.total || '-' }}</div>
                    </div>
                    <div class="project-meta">Estado: <strong>{{ proj.carpintero_estado }}</strong></div>
                  </div>
                  <div style="margin-top:6px; text-align:right;"><button class="btn btn-ghost" (click)="openDetails(proj)">Ver detalles</button></div>
                  <div class="project-desc">{{ proj.descripcion }}</div>
                  <div class="progress-controls">
                    <label class="small-muted">Estado:</label>
                    <select [ngModel]="proj.pendingEstado ?? proj.carpintero_estado" (ngModelChange)="setPendingStatus(proj, $event)">
                      <option value="to-do">To-Do</option>
                      <option value="in progress">In Progress</option>
                      <option value="done">Done</option>
                    </select>
                    <button class="btn btn-primary" (click)="requestSaveProject(proj)">Guardar</button>
                  </div>
                </div>
              }
            </div>
          </div>
          <div style="margin-top: 1rem; text-align: right;">
            <button class="btn btn-ghost" (click)="loadAcceptedProjects()">Refrescar</button>
            <button class="btn btn-primary" (click)="requestSaveAll()">Guardar todos</button>
          </div>
        </div>
      </mat-tab>

      <mat-tab label="Pedidos">
        <div class="tab-content">
          <h2>Pedidos (carrito)</h2>
          @if (orders.length === 0) {
            <div>No hay pedidos.</div>
          }
          @if (orders.length) {
            <div class="columns-wrapper">
              <div class="column">
                <h3>To-Do</h3>
                @if (orderTodoList.length === 0) {
                  <div class="small-muted">No hay pedidos en To-Do.</div>
                }
                @for (o of orderTodoList; track o.id ?? o.pedido_id ?? o) {
                  <div class="project-card">
                    <div class="project-row">
                      <div>
                        <h3>{{ o.titulo || o.title || ('Pedido #' + (o.id || o.pedido_id)) }}</h3>
                        <div class="project-meta small-muted">Cliente: {{ o.cliente_nombre || o.customer_name || '-' }}</div>
                        <div class="project-meta small-muted">Total: {{ o.total || o.totalPrice || '-' }}</div>
                      </div>
                      <div class="project-meta">Estado: <strong>{{ o.estado || o.status || 'pendiente' }}</strong></div>
                    </div>
                    <div style="margin-top:6px; text-align:right;"><button class="btn btn-ghost" (click)="openDetails(o)">Ver</button></div>
                    <div class="project-desc">{{ o.descripcion || o.description || '' }}</div>
                    <div class="progress-controls">
                      <label class="small-muted">Estado:</label>
                      <select [ngModel]="o.pendingEstado ?? o.estado" (ngModelChange)="o.pendingEstado = $event">
                        <option value="pendiente">To-Do</option>
                        <option value="in progress">In Progress</option>
                        <option value="done">Done</option>
                      </select>
                      <button class="btn btn-primary" (click)="saveOrderStatus(o)">Guardar</button>
                    </div>
                  </div>
                }
              </div>
              <div class="column">
                <h3>In Progress</h3>
                @if (orderInProgressList.length === 0) {
                  <div class="small-muted">No hay pedidos en progreso.</div>
                }
                @for (o of orderInProgressList; track o.id ?? o.pedido_id ?? o) {
                  <div class="project-card">
                    <div class="project-row">
                      <div>
                        <h3>{{ o.titulo || o.title || ('Pedido #' + (o.id || o.pedido_id)) }}</h3>
                        <div class="project-meta small-muted">Cliente: {{ o.cliente_nombre || o.customer_name || '-' }}</div>
                        <div class="project-meta small-muted">Total: {{ o.total || o.totalPrice || '-' }}</div>
                      </div>
                      <div class="project-meta">Estado: <strong>{{ o.estado || o.status || 'in progress' }}</strong></div>
                    </div>
                    <div style="margin-top:6px; text-align:right;"><button class="btn btn-ghost" (click)="openDetails(o)">Ver</button></div>
                    <div class="project-desc">{{ o.descripcion || o.description || '' }}</div>
                    <div class="progress-controls">
                      <label class="small-muted">Estado:</label>
                      <select [ngModel]="o.pendingEstado ?? o.estado" (ngModelChange)="o.pendingEstado = $event">
                        <option value="pendiente">To-Do</option>
                        <option value="in progress">In Progress</option>
                        <option value="done">Done</option>
                      </select>
                      <button class="btn btn-primary" (click)="saveOrderStatus(o)">Guardar</button>
                    </div>
                  </div>
                }
              </div>
              <div class="column">
                <h3>Done</h3>
                @if (orderDoneList.length === 0) {
                  <div class="small-muted">No hay pedidos finalizados.</div>
                }
                @for (o of orderDoneList; track o.id ?? o.pedido_id ?? o) {
                  <div class="project-card">
                    <div class="project-row">
                      <div>
                        <h3>{{ o.titulo || o.title || ('Pedido #' + (o.id || o.pedido_id)) }}</h3>
                        <div class="project-meta small-muted">Cliente: {{ o.cliente_nombre || o.customer_name || '-' }}</div>
                        <div class="project-meta small-muted">Total: {{ o.total || o.totalPrice || '-' }}</div>
                      </div>
                      <div class="project-meta">Estado: <strong>{{ o.estado || o.status || 'done' }}</strong></div>
                    </div>
                    <div style="margin-top:6px; text-align:right;"><button class="btn btn-ghost" (click)="openDetails(o)">Ver</button></div>
                    <div class="project-desc">{{ o.descripcion || o.description || '' }}</div>
                    <div class="progress-controls">
                      <label class="small-muted">Estado:</label>
                      <select [ngModel]="o.pendingEstado ?? o.estado" (ngModelChange)="o.pendingEstado = $event">
                        <option value="pendiente">To-Do</option>
                        <option value="in progress">In Progress</option>
                        <option value="done">Done</option>
                      </select>
                      <button class="btn btn-primary" (click)="saveOrderStatus(o)">Guardar</button>
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          <span class="tab-label-with-badge">
            Messages
            @if (unreadMessageCount > 0) {
              <span class="messages-badge">{{ unreadMessageCount }}</span>
            }
          </span>
        </ng-template>
        <div class="tab-content">
          <div class="messages-heading">
            <h2>Client Messages</h2>
            @if (unreadMessageCount > 0) {
              <div class="messages-badge">
                {{ unreadMessageCount }} new
              </div>
            }
          </div>
          @if (messagesLoading) {
            <div class="loading-state">Loading messages...</div>
          }
          @if (messagesError) {
            <div class="error-state">{{ messagesError }}</div>
          }
          @if (!messagesLoading && !messagesError) {
            <div class="messages-list">
              @for (msg of contactMessages; track msg.id ?? msg.email ?? msg) {
                <article class="message-card">
                  <div class="message-header">
                    <div>
                      <h3>{{ msg.name }}</h3>
                      <p class="message-meta">
                        <span>{{ msg.email }}</span>
                        @if (msg.phone) {
                          <span>| {{ msg.phone }}</span>
                        }
                      </p>
                    </div>
                    <div class="message-status-block">
                  <span class="status-pill" [ngClass]="{
                    'status-new': msg.status === 'new',
                    'status-read': msg.status === 'read',
                    'status-responded': msg.status === 'responded'
                  }">
                        {{ formatMessageStatus(msg.status) }}
                      </span>
                      @if (isMessageUnread(msg)) {
                        <span class="unread-indicator">Nuevo</span>
                      }
                    </div>
                  </div>
                  @if (msg.subject) {
                    <p class="message-subject">{{ msg.subject }}</p>
                  }
                  <p class="message-body">{{ msg.message }}</p>
                  <div class="message-status-actions">
                    <button type="button"
                      class="btn btn-ghost"
                      (click)="markMessageStatus(msg, 'read')"
                      [disabled]="!isMessageUnread(msg)">
                      Marcar como leÃ­do
                    </button>
                    <button type="button"
                      class="btn btn-ghost"
                      (click)="markMessageStatus(msg, 'new')"
                      [disabled]="isMessageUnread(msg)">
                      Marcar como no leÃ­do
                    </button>
                  </div>
                  @if (msg.response) {
                    <div class="response-block">
                      <strong>Response:</strong>
                      <p>{{ msg.response }}</p>
                      @if (msg.response_created_at) {
                        <small>Sent: {{ msg.response_created_at | date:'short' }}</small>
                      }
                    </div>
                  }
                  <div class="message-actions">
                    <textarea [(ngModel)]="msg.pendingResponse" placeholder="Write a response..."></textarea>
                    <button (click)="sendResponse(msg)">Send Reply</button>
                  </div>
                </article>
              }
              @if (contactMessages.length === 0) {
                <p class="empty-state">No messages yet.</p>
              }
            </div>
          }
        </div>
      </mat-tab>
    </mat-tab-group>
  </div>

  @if (showRejectionModal) {
    <app-rejection-modal
      [isOpen]="showRejectionModal"
      [(motivo)]="rejectionMotivo"
      (confirm)="sendReject()"
      (cancel)="closeModal()">
    </app-rejection-modal>
  }

  @if (showConfirmModal) {
    <app-confirmation-modal
      [isOpen]="showConfirmModal"
      [message]="confirmMessage"
      (confirm)="onConfirmModalConfirm()"
      (cancel)="onConfirmModalCancel()">
    </app-confirmation-modal>
  }

  @if (showPriceModal) {
    <app-price-modal
      [isOpen]="showPriceModal"
      [presupuesto]="priceModalPresupuesto"
      (confirm)="onPriceModalConfirm($event)"
      (cancel)="onPriceModalCancel()">
    </app-price-modal>
  }

  @if (showDetailModal) {
    <app-furniture-detail-modal
      [isOpen]="showDetailModal"
      [data]="detailModalData"
      (cancel)="closeDetails()">
    </app-furniture-detail-modal>
  }

  @if (toastVisible) {
    <app-toast-notification
      [message]="toastMessage"
      [type]="toastType"
      [duration]="toastDuration">
    </app-toast-notification>
  }


  <app-footer></app-footer>
</main>
