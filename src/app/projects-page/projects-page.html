<app-nav></app-nav>

<main class="projects-page">
  <section class="projects-hero">
    <div class="inner">
      <h1 class="title">Our Projects</h1>
      <p class="lead">Explore our completed works by room. Select a category to view the projects.</p>
      @if (isAdmin) {
        <div class="admin-toolbar">
          <button class="admin-add-btn" (click)="toggleAddForm()">
            {{ showAddForm ? 'Close' : 'Add' }} new project
          </button>
        </div>
      }
    </div>
  </section>

  @if (isAdmin && showAddForm) {
    <section class="admin-add-section" aria-live="polite">
      <div class="inner">
        <div class="admin-card">
          <header class="admin-card-header">
            <div>
              <p class="eyebrow">Project Management</p>
              <h2>Create New Project</h2>
            </div>
            <button class="admin-close" type="button" (click)="toggleAddForm()" aria-label="Close form">
              &times;
            </button>
          </header>

          <form [formGroup]="addProjectForm" (ngSubmit)="submitNewProject()" class="admin-add-form">
            <div class="form-grid">
              <label class="form-field">
                <span>Title*</span>
                <input type="text" formControlName="titulo" placeholder="E.g. Modern Minimalist Kitchen">
                @if (addProjectForm.get('titulo')?.invalid && addProjectForm.get('titulo')?.touched) {
                  <small class="error-text">Title is required.</small>
                }
              </label>

              <label class="form-field">
                <span>Category*</span>
                <select formControlName="categoria">
                  <option value="kitchen">Kitchen</option>
                  <option value="bathroom">Bathroom</option>
                  <option value="bedroom">Bedroom</option>
                  <option value="livingroom">Living Room</option>
                  <option value="others">Others</option>
                </select>
              </label>

              <label class="form-field">
                <span>Client*</span>
                <input type="text" formControlName="cliente" placeholder="Client Name">
                @if (addProjectForm.get('cliente')?.invalid && addProjectForm.get('cliente')?.touched) {
                  <small class="error-text">Client is required.</small>
                }
              </label>

              <label class="form-field">
                <span>Location*</span>
                <input type="text" formControlName="ubicacion" placeholder="City, Country">
                @if (addProjectForm.get('ubicacion')?.invalid && addProjectForm.get('ubicacion')?.touched) {
                  <small class="error-text">Location is required.</small>
                }
              </label>

              <label class="form-field">
                <span>Completion Date*</span>
                <input type="date" formControlName="fecha_completado">
                @if (addProjectForm.get('fecha_completado')?.invalid && addProjectForm.get('fecha_completado')?.touched) {
                  <small class="error-text">Completion date is required.</small>
                }
              </label>

              <label class="form-field">
                <span>Duration (days)*</span>
                <input type="number" formControlName="duracion_dias" min="1" placeholder="30">
                @if (addProjectForm.get('duracion_dias')?.invalid && addProjectForm.get('duracion_dias')?.touched) {
                  <small class="error-text">Enter a valid duration.</small>
                }
              </label>

              <label class="form-field">
                <span>Budget*</span>
                <input type="number" formControlName="presupuesto" min="0" step="0.01" placeholder="5000.00">
                @if (addProjectForm.get('presupuesto')?.invalid && addProjectForm.get('presupuesto')?.touched) {
                  <small class="error-text">Enter a valid budget.</small>
                }
              </label>

              <label class="form-field">
                <span>Area (m²)*</span>
                <input type="number" formControlName="area_m2" min="1" step="0.01" placeholder="25.5">
                @if (addProjectForm.get('area_m2')?.invalid && addProjectForm.get('area_m2')?.touched) {
                  <small class="error-text">Enter a valid area.</small>
                }
              </label>

              <label class="form-field">
                <span>Style*</span>
                <input type="text" formControlName="estilo" placeholder="Modern, Rustic, etc.">
                @if (addProjectForm.get('estilo')?.invalid && addProjectForm.get('estilo')?.touched) {
                  <small class="error-text">Style is required.</small>
                }
              </label>
            </div>

            <label class="form-field">
              <span>Description*</span>
              <textarea formControlName="descripcion" rows="3" placeholder="Describe the project..."></textarea>
              @if (addProjectForm.get('descripcion')?.invalid && addProjectForm.get('descripcion')?.touched) {
                <small class="error-text">Description is required.</small>
              }
            </label>

            <label class="form-field">
              <span>Images (URLs, one per line)*</span>
              <textarea formControlName="imagenes" rows="3" placeholder="https://example.com/image1.jpg&#10;https://example.com/image2.jpg"></textarea>
              @if (addProjectForm.get('imagenes')?.invalid && addProjectForm.get('imagenes')?.touched) {
                <small class="error-text">Add at least one image.</small>
              }
            </label>

            <label class="form-field">
              <span>Materials (one per line)</span>
              <textarea formControlName="materiales" rows="2" placeholder="Oak wood&#10;Granite&#10;Stainless steel"></textarea>
            </label>

            <div class="form-row checkbox-row">
              <label class="checkbox-field">
                <input type="checkbox" formControlName="destacado">
                <span>Featured Project</span>
              </label>
            </div>

            @if (saveError) {
              <p class="status-message error">{{ saveError }}</p>
            }
            @if (saveSuccess) {
              <p class="status-message success">{{ saveSuccess }}</p>
            }

            <div class="form-actions">
              <button type="button" class="btn-secondary" (click)="toggleAddForm()">Cancel</button>
              <button type="submit" class="btn-primary" [disabled]="isSaving">
                {{ isSaving ? 'Saving…' : 'Save Project' }}
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>
  }

  <section class="projects-grid-section">
    <div class="inner">
      <!-- Loading State -->
      @if (isLoading) {
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Loading projects...</p>
        </div>
      }

      <!-- Error State -->
      @if (errorMessage && !isLoading) {
        <div class="error-container">
          <p class="error-message">{{ errorMessage }}</p>
          <button class="retry-button" (click)="retryLoad()">Retry</button>
        </div>
      }

      <!-- Projects Grid -->
      @if (!isLoading && !errorMessage) {
        <div class="projects-grid" role="list">
          <article class="project-card" role="listitem" routerLink="kitchen" tabindex="0" aria-label="Kitchen">
            <div class="media kitchen" aria-hidden="true"></div>
            <h3 class="project-name">Kitchen</h3>
            <p class="project-desc">Modern and functional designs</p>
            <span class="project-count">{{ categoryCounts['kitchen'] }} projects</span>
          </article>
          <article class="project-card" role="listitem" routerLink="bathroom" tabindex="0" aria-label="Bathroom">
            <div class="media bathroom" aria-hidden="true"></div>
            <h3 class="project-name">Bathroom</h3>
            <p class="project-desc">Comfort spaces</p>
            <span class="project-count">{{ categoryCounts['bathroom'] }} projects</span>
          </article>
          <article class="project-card" role="listitem" routerLink="livingroom" tabindex="0" aria-label="Living room">
            <div class="media livingroom" aria-hidden="true"></div>
            <h3 class="project-name">Living Room</h3>
            <p class="project-desc">Cozy environments</p>
            <span class="project-count">{{ categoryCounts['livingroom'] }} projects</span>
          </article>
          <article class="project-card" role="listitem" routerLink="bedroom" tabindex="0" aria-label="Bedroom">
            <div class="media bedroom" aria-hidden="true"></div>
            <h3 class="project-name">Bedroom</h3>
            <p class="project-desc">Rest spaces</p>
            <span class="project-count">{{ categoryCounts['bedroom'] }} projects</span>
          </article>
          <article class="project-card" role="listitem" routerLink="others" tabindex="0" aria-label="Others">
            <div class="media other" aria-hidden="true"></div>
            <h3 class="project-name">Others</h3>
            <p class="project-desc">Custom furniture</p>
            <span class="project-count">{{ categoryCounts['others'] }} projects</span>
          </article>
        </div>
      }
    </div>
  </section>

  <!-- Outlet para las rutas hijas -->
  <router-outlet></router-outlet>
</main>

<!-- Delete Confirmation Modal -->
<app-confirmation-modal
  [isOpen]="showDeleteConfirm"
  title="Confirm deletion"
  message="Are you sure you want to delete this project? This action cannot be undone."
  confirmLabel="Delete"
  cancelLabel="Cancel"
  (confirm)="executeDelete()"
  (cancel)="cancelDelete()">
</app-confirmation-modal>

<app-footer></app-footer>
